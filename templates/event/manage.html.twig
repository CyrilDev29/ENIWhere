{# templates/event/manage.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Gérer l'événement{% endblock %}

{% block body %}

    {# Flash messages #}
    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert alert-{{ label }} mb-3">{{ message }}</div>
        {% endfor %}
    {% endfor %}

    <h1 class="mb-3">Gérer l'événement : {{ event.name ?? ('Événement #' ~ event.id) }}</h1>

    <p class="mb-4">
        <strong>Place workflow :</strong> {{ event.state }}<br>
        {#  <strong>État BDD :</strong> {{ event.state ? event.state.label : '—' }}#}
    </p>
<div class="actions">
    {# Publier: draft -> published #}
    <form method="post" action="{{ path('event_publish', {id: event.id}) }}" style="display:inline">
        <input type="hidden" name="_token" value="{{ csrf_token('publish_event_' ~ event.id) }}">
        <button class="btn btn-sm btn-primary" {% if event.state != 'CREATED' %}disabled{% endif %}>Publier</button>
    </form>

    {# Ouvrir inscriptions: published -> registration_open #}
    <form method="post" action="{{ path('event_open_regs', {id: event.id}) }}" style="display:inline">
        <input type="hidden" name="_token" value="{{ csrf_token('open_event_' ~ event.id) }}">
        <button class="btn btn-sm btn-secondary" {% if event.state != 'PUBLISHED' %}disabled{% endif %}>Ouvrir inscriptions</button>
    </form>

    {# Fermer inscriptions: registration_open -> registration_closed #}
    <form method="post" action="{{ path('event_close_regs', {id: event.id}) }}" style="display:inline">
        <input type="hidden" name="_token" value="{{ csrf_token('close_event_' ~ event.id) }}">
        <button class="btn btn-sm btn-warning" {% if event.state != 'OPEN' %}disabled{% endif %}>Fermer inscriptions</button>
    </form>

    {# Démarrer: registration_closed -> ongoing #}
    <form method="post" action="{{ path('event_start', {id: event.id}) }}" style="display:inline">
        <input type="hidden" name="_token" value="{{ csrf_token('start_event_' ~ event.id) }}">
        <button class="btn btn-sm btn-info" {% if event.state != 'CLOSED' %}disabled{% endif %}>Démarrer</button>
    </form>

    {# Terminer: ongoing -> finished #}
    <form method="post" action="{{ path('event_finish', {id: event.id}) }}" style="display:inline">
        <input type="hidden" name="_token" value="{{ csrf_token('finish_event_' ~ event.id) }}">
        <button class="btn btn-sm btn-success" {% if event.state != 'ONGOING' %}disabled{% endif %}>Terminer</button>
    </form>

    {# Annuler: (tous sauf finished/canceled) -> canceled #}
    <form method="post" action="{{ path('event_cancel', {id: event.id}) }}" style="display:inline">
        <input type="hidden" name="_token" value="{{ csrf_token('cancel_event_' ~ event.id) }}">
        <button class="btn btn-sm btn-danger" {% if event.state in ['FINISHED','CANCELED'] %}disabled{% endif %}>Annuler</button>
    </form>

    </div>

    {# ====== Carte détails ====== #}
    <div class="card p-4 shadow rounded mb-4">
        <h2 class="mb-3">{{ event.name }}</h2>
        <p><strong>Date de début :</strong> {{ event.startDateTime ? event.startDateTime|date('d/m/Y H:i') : '—' }}</p>
        <p><strong>Date limite d'inscription :</strong> {{ event.registrationDeadline ? event.registrationDeadline|date('d/m/Y H:i') : '—' }}</p>
        <p><strong>Durée :</strong> {{ event.duration is not null ? event.duration ~ ' h' : '—' }}</p>
        <p><strong>Description :</strong> {{ event.description ?? '—' }}</p>
        <p><strong>Lieu :</strong> {{ event.place ? event.place.name : 'Non défini' }}</p>
        <p><strong>Adresse :</strong>
            {% if event.place %}
                {{ event.place.street ?? '—' }},
                {{ event.place.city ? event.place.city.name ~ ' ' ~ event.place.city.postalCode : '' }}
            {% else %} — {% endif %}
        </p>
        <p><strong>Organisateur :</strong> {{ event.organizer ? event.organizer.username : 'Inconnu' }}</p>
        <p><strong>Participants :</strong> {{ event.registrations|length }} / {{ event.maxParticipant ?? '—' }}</p>
    </div>

    {# ====== Mode édition : affichage du formulaire pré-rempli ====== #}
    {% if form is defined %}
        <div class="card p-4 shadow rounded mb-4">
            <h3 class="mb-3">Modifier l'événement</h3>
            {{ form_start(form, { attr: { novalidate: 'novalidate' } }) }}
            {{ form_errors(form) }}

            {# Si tu veux laisser Symfony tout rendre #}
            {{ form_widget(form) }}

            {# OU, si tu préfères l’ordre, remplace par des form_row explicites :
          {{ form_row(form.name) }}
          {{ form_row(form.description) }}
          {{ form_row(form.startDateTime) }}
          {{ form_row(form.registrationDeadline) }}
          {{ form_row(form.duration) }}
          {{ form_row(form.maxParticipant) }}
          {{ form_row(form.place) }}
          {{ form_row(form.city) }}
          {{ form_row(form.street) }}
          {{ form_row(form.postalCode) }}
          {{ form_row(form.gpsLatitude) }}
          {{ form_row(form.gpsLongitude) }}
            #}

            <div class="mt-3">
                <button class="btn btn-primary">Enregistrer</button>
                <a href="{{ path('event_manage', { id: event.id }) }}" class="btn btn-secondary">Annuler</a>
            </div>
            {{ form_end(form) }}
        </div>
    {% else %}
        {# Mode lecture : bouton Modifier + Retour #}
        <a href="{{ path('event_edit', { id: event.id }) }}" class="btn btn-warning btn-sm">Modifier</a>
        <a href="{{ path('event_index') }}" class="btn btn-secondary btn-sm">Retour</a>
    {% endif %}

{% endblock %}
